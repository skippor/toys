<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XySSL: include/xyssl/openssl.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>include/xyssl/openssl.h</h1><a href="openssl_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00004"></a>00004 <span class="comment">/*</span>
<a name="l00005"></a>00005 <span class="comment"> * OpenSSL wrapper contributed by David Barett</span>
<a name="l00006"></a>00006 <span class="comment"> */</span>
<a name="l00007"></a>00007 <span class="preprocessor">#ifndef XYSSL_OPENSSL_H</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor">#define XYSSL_OPENSSL_H</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span>
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="aes_8h.html">xyssl/aes.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="md5_8h.html">xyssl/md5.h</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "<a class="code" href="rsa_8h.html">xyssl/rsa.h</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="sha1_8h.html">xyssl/sha1.h</a>"</span>
<a name="l00014"></a>00014 
<a name="l00015"></a><a class="code" href="openssl_8h.html#6a78c103678233c6f750ef0a8347596f">00015</a> <span class="preprocessor">#define AES_SIZE                16</span>
<a name="l00016"></a><a class="code" href="openssl_8h.html#f19ab913a847ad1e91c5291215116de1">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define AES_BLOCK_SIZE          16</span>
<a name="l00017"></a><a class="code" href="openssl_8h.html#61811e8ccf90414b5fc4ef2cdef17dc0">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define AES_KEY                 aes_context</span>
<a name="l00018"></a><a class="code" href="openssl_8h.html#71b7c53816d90dc180b03df889aacd18">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define MD5_CTX                 md5_context</span>
<a name="l00019"></a><a class="code" href="openssl_8h.html#089034717a043583f7b3e7ce09979f2d">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define SHA_CTX                 sha1_context</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="openssl_8h.html#992f5751d71f5ef12a120c8920ac0d35">00021</a> <span class="preprocessor">#define SHA1_Init( CTX ) \</span>
<a name="l00022"></a>00022 <span class="preprocessor">        sha1_starts( (CTX) )</span>
<a name="l00023"></a><a class="code" href="openssl_8h.html#a252094f96215633d009484db8ec224b">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define SHA1_Update(  CTX, BUF, LEN ) \</span>
<a name="l00024"></a>00024 <span class="preprocessor">        sha1_update( (CTX), (unsigned char *)(BUF), (LEN) )</span>
<a name="l00025"></a><a class="code" href="openssl_8h.html#6f34d70cbf184a5535f61dd94be142f5">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define SHA1_Final( OUT, CTX ) \</span>
<a name="l00026"></a>00026 <span class="preprocessor">        sha1_finish( (CTX), (OUT) )</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="openssl_8h.html#4f907ff0b2a85e57ec4b9846e9103568">00028</a> <span class="preprocessor">#define MD5_Init( CTX ) \</span>
<a name="l00029"></a>00029 <span class="preprocessor">        md5_starts( (CTX) )</span>
<a name="l00030"></a><a class="code" href="openssl_8h.html#70ede4d210c7ff38587571cf9678a335">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define MD5_Update( CTX, BUF, LEN ) \</span>
<a name="l00031"></a>00031 <span class="preprocessor">        md5_update( (CTX), (unsigned char *)(BUF), (LEN) )</span>
<a name="l00032"></a><a class="code" href="openssl_8h.html#266a0d56baafce173fef0dff335bfb33">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define MD5_Final( OUT, CTX ) \</span>
<a name="l00033"></a>00033 <span class="preprocessor">        md5_finish( (CTX), (OUT) )</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="openssl_8h.html#ae0c5eab623025b169699cd15367d052">00035</a> <span class="preprocessor">#define AES_set_encrypt_key( KEY, KEYSIZE, CTX ) \</span>
<a name="l00036"></a>00036 <span class="preprocessor">        aes_setkey_enc( (CTX), (KEY), (KEYSIZE) )</span>
<a name="l00037"></a><a class="code" href="openssl_8h.html#50a022e839617adf0edfdeb2de003514">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define AES_set_decrypt_key( KEY, KEYSIZE, CTX ) \</span>
<a name="l00038"></a>00038 <span class="preprocessor">        aes_setkey_dec( (CTX), (KEY), (KEYSIZE) )</span>
<a name="l00039"></a><a class="code" href="openssl_8h.html#22aee75e8fcb08dc851e096847a0d77b">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define AES_cbc_encrypt( INPUT, OUTPUT, LEN, CTX, IV, MODE ) \</span>
<a name="l00040"></a>00040 <span class="preprocessor">        aes_crypt_cbc( (CTX), (MODE), (LEN), (IV), (INPUT), (OUTPUT) )</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="comment">/*</span>
<a name="l00043"></a>00043 <span class="comment"> * RSA stuff follows. TODO: needs cleanup</span>
<a name="l00044"></a>00044 <span class="comment"> */</span>
<a name="l00045"></a><a class="code" href="openssl_8h.html#1d6905a6ad2d055159c29d7e48800528">00045</a> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="openssl_8h.html#1d6905a6ad2d055159c29d7e48800528">__RSA_Passthrough</a>( <span class="keywordtype">void</span> *output, <span class="keywordtype">void</span> *input, <span class="keywordtype">int</span> size )
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047     memcpy( output, input, size );
<a name="l00048"></a>00048     <span class="keywordflow">return</span> size;
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="openssl_8h.html#3ef8f12eabc686aa7c33f77bf2e98799">00051</a> <span class="keyword">inline</span> <a class="code" href="structrsa__context.html">rsa_context</a>* <a class="code" href="openssl_8h.html#3ef8f12eabc686aa7c33f77bf2e98799">d2i_RSA_PUBKEY</a>( <span class="keywordtype">void</span> *ignore, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **bufptr,
<a name="l00052"></a>00052                                     <span class="keywordtype">int</span> len )
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buffer = *(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **) bufptr;
<a name="l00055"></a>00055     <a class="code" href="structrsa__context.html">rsa_context</a> *rsa;
<a name="l00056"></a>00056     
<a name="l00057"></a>00057     <span class="comment">/*</span>
<a name="l00058"></a>00058 <span class="comment">     * Not a general-purpose parser: only parses public key from *exactly*</span>
<a name="l00059"></a>00059 <span class="comment">     *   openssl genrsa -out privkey.pem 512 (or 1024)</span>
<a name="l00060"></a>00060 <span class="comment">     *   openssl rsa -in privkey.pem -out privatekey.der -outform der</span>
<a name="l00061"></a>00061 <span class="comment">     *   openssl rsa -in privkey.pem -out pubkey.der -outform der -pubout</span>
<a name="l00062"></a>00062 <span class="comment">     *</span>
<a name="l00063"></a>00063 <span class="comment">     * TODO: make a general-purpose parse</span>
<a name="l00064"></a>00064 <span class="comment">     */</span>
<a name="l00065"></a>00065     <span class="keywordflow">if</span>( ignore != 0 || ( len != 94 &amp;&amp; len != 162 ) )
<a name="l00066"></a>00066         <span class="keywordflow">return</span>( 0 );
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     rsa = (<a class="code" href="structrsa__context.html">rsa_context</a> *) malloc( <span class="keyword">sizeof</span>( rsa_rsa ) );
<a name="l00069"></a>00069     <span class="keywordflow">if</span>( rsa == NULL )
<a name="l00070"></a>00070         <span class="keywordflow">return</span>( 0 );
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     memset( rsa, 0, <span class="keyword">sizeof</span>( <a class="code" href="structrsa__context.html">rsa_context</a> ) );
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="keywordflow">if</span>( ( len ==  94 &amp;&amp; 
<a name="l00075"></a>00075           <a class="code" href="bignum_8h.html#ee83823822646a6653b479d265ffc7fa">mpi_read_binary</a>( &amp;rsa-&gt;<a class="code" href="structrsa__context.html#2f44f168531d8470e7831fd49aea9ae0">N</a>, &amp;buffer[ 25],  64 ) == 0 &amp;&amp;
<a name="l00076"></a>00076           <a class="code" href="bignum_8h.html#ee83823822646a6653b479d265ffc7fa">mpi_read_binary</a>( &amp;rsa-&gt;<a class="code" href="structrsa__context.html#a28db934350d34ac8537abb7ec8d519d">E</a>, &amp;buffer[ 91],   3 ) == 0 ) ||
<a name="l00077"></a>00077         ( len == 162 &amp;&amp;
<a name="l00078"></a>00078           <a class="code" href="bignum_8h.html#ee83823822646a6653b479d265ffc7fa">mpi_read_binary</a>( &amp;rsa-&gt;<a class="code" href="structrsa__context.html#2f44f168531d8470e7831fd49aea9ae0">N</a>, &amp;buffer[ 29], 128 ) == 0 ) &amp;&amp;
<a name="l00079"></a>00079           <a class="code" href="bignum_8h.html#ee83823822646a6653b479d265ffc7fa">mpi_read_binary</a>( &amp;rsa-&gt;<a class="code" href="structrsa__context.html#a28db934350d34ac8537abb7ec8d519d">E</a>, &amp;buffer[159],   3 ) == 0 )
<a name="l00080"></a>00080     {
<a name="l00081"></a>00081         <span class="comment">/*</span>
<a name="l00082"></a>00082 <span class="comment">         * key read successfully</span>
<a name="l00083"></a>00083 <span class="comment">         */</span>
<a name="l00084"></a>00084         rsa-&gt;<a class="code" href="structrsa__context.html#d7cfe15a30f515633ad3172a9720b220">len</a> = ( <a class="code" href="bignum_8h.html#cfc9283c45ac1e2ffddcf25ac87d0b8b">mpi_msb</a>( &amp;rsa-&gt;<a class="code" href="structrsa__context.html#2f44f168531d8470e7831fd49aea9ae0">N</a> ) + 7 ) &gt;&gt; 3;
<a name="l00085"></a>00085         <span class="keywordflow">return</span>( rsa );
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087     <span class="keywordflow">else</span>
<a name="l00088"></a>00088     {
<a name="l00089"></a>00089         memset( rsa, 0, <span class="keyword">sizeof</span>( rsa_context ) );
<a name="l00090"></a>00090         free( rsa );
<a name="l00091"></a>00091         <span class="keywordflow">return</span>( 0 );
<a name="l00092"></a>00092     }
<a name="l00093"></a>00093 }
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="openssl_8h.html#8f8e564107d1c68ba6367934fa576f99">00095</a> <span class="preprocessor">#define RSA                     rsa_context</span>
<a name="l00096"></a><a class="code" href="openssl_8h.html#956e098e06febab7fd7d835f59675d4d">00096</a> <span class="preprocessor"></span><span class="preprocessor">#define RSA_PKCS1_PADDING       1 </span><span class="comment">/* ignored; always encrypt with this */</span>
<a name="l00097"></a><a class="code" href="openssl_8h.html#013e64a208fc09efad75e9d1ee3d9e08">00097</a> <span class="preprocessor">#define RSA_size( CTX )         (CTX)-&gt;len</span>
<a name="l00098"></a><a class="code" href="openssl_8h.html#d87ca0174a53199e1ba4f275d99b74f3">00098</a> <span class="preprocessor"></span><span class="preprocessor">#define RSA_free( CTX )         rsa_free( CTX )</span>
<a name="l00099"></a><a class="code" href="openssl_8h.html#0421d3e9eed58a9a02b7ff9aa7cce2ff">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define ERR_get_error( )        "ERR_get_error() not supported"</span>
<a name="l00100"></a><a class="code" href="openssl_8h.html#e7192b40529b251d1db6a889bafbc4ac">00100</a> <span class="preprocessor"></span><span class="preprocessor">#define RSA_blinding_off( IGNORE )</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00102"></a><a class="code" href="openssl_8h.html#f7ae4f4742a1ed30603c4f442cf49128">00102</a> <span class="preprocessor">#define d2i_RSAPrivateKey( a, b, c ) new rsa_context </span><span class="comment">/* TODO: C++ bleh */</span>
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="openssl_8h.html#6471ad4aade90b6066a75c2c24ede7d9">00104</a> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="openssl_8h.html#6471ad4aade90b6066a75c2c24ede7d9">RSA_public_decrypt</a> ( <span class="keywordtype">int</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* input, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* output, <a class="code" href="openssl_8h.html#8f8e564107d1c68ba6367934fa576f99">RSA</a>* key, <span class="keywordtype">int</span> ignore ) { <span class="keywordtype">int</span> outsize=size; <span class="keywordflow">if</span>( !<a class="code" href="rsa_8h.html#fbf579a70b3c9ce8b33beb3370d2b665">rsa_pkcs1_decrypt</a>( key, <a class="code" href="rsa_8h.html#1f00bab389d3db27a115db74e32be727">RSA_PUBLIC</a>,  &amp;outsize, input, output ) ) <span class="keywordflow">return</span> outsize; <span class="keywordflow">else</span> <span class="keywordflow">return</span> -1; }
<a name="l00105"></a><a class="code" href="openssl_8h.html#8eb365940811c8ac89b9fe41d7a89776">00105</a> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="openssl_8h.html#8eb365940811c8ac89b9fe41d7a89776">RSA_private_decrypt</a>( <span class="keywordtype">int</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* input, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* output, <a class="code" href="openssl_8h.html#8f8e564107d1c68ba6367934fa576f99">RSA</a>* key, <span class="keywordtype">int</span> ignore ) { <span class="keywordtype">int</span> outsize=size; <span class="keywordflow">if</span>( !<a class="code" href="rsa_8h.html#fbf579a70b3c9ce8b33beb3370d2b665">rsa_pkcs1_decrypt</a>( key, <a class="code" href="rsa_8h.html#eaabdd3bae85e564beb1ae9843169eb9">RSA_PRIVATE</a>, &amp;outsize, input, output ) ) <span class="keywordflow">return</span> outsize; <span class="keywordflow">else</span> <span class="keywordflow">return</span> -1; }
<a name="l00106"></a><a class="code" href="openssl_8h.html#6ee115b261009676bd2594df6601f192">00106</a> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="openssl_8h.html#6ee115b261009676bd2594df6601f192">RSA_public_encrypt</a> ( <span class="keywordtype">int</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* input, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* output, <a class="code" href="openssl_8h.html#8f8e564107d1c68ba6367934fa576f99">RSA</a>* key, <span class="keywordtype">int</span> ignore ) { <span class="keywordflow">if</span>( !<a class="code" href="rsa_8h.html#db0b1f4b9b5786d538fe795154dd0a65">rsa_pkcs1_encrypt</a>( key, <a class="code" href="rsa_8h.html#1f00bab389d3db27a115db74e32be727">RSA_PUBLIC</a>,  size, input, output ) ) <span class="keywordflow">return</span> <a class="code" href="openssl_8h.html#013e64a208fc09efad75e9d1ee3d9e08">RSA_size</a>(key); <span class="keywordflow">else</span> <span class="keywordflow">return</span> -1; }
<a name="l00107"></a><a class="code" href="openssl_8h.html#f1e23e3dcec6cbeb37ddf58369050279">00107</a> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="openssl_8h.html#f1e23e3dcec6cbeb37ddf58369050279">RSA_private_encrypt</a>( <span class="keywordtype">int</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* input, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* output, <a class="code" href="openssl_8h.html#8f8e564107d1c68ba6367934fa576f99">RSA</a>* key, <span class="keywordtype">int</span> ignore ) { <span class="keywordflow">if</span>( !<a class="code" href="rsa_8h.html#db0b1f4b9b5786d538fe795154dd0a65">rsa_pkcs1_encrypt</a>( key, <a class="code" href="rsa_8h.html#eaabdd3bae85e564beb1ae9843169eb9">RSA_PRIVATE</a>, size, input, output ) ) <span class="keywordflow">return</span> <a class="code" href="openssl_8h.html#013e64a208fc09efad75e9d1ee3d9e08">RSA_size</a>(key); <span class="keywordflow">else</span> <span class="keywordflow">return</span> -1; }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="preprocessor">#ifdef __cplusplus</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>}
<a name="l00111"></a>00111 <span class="preprocessor">#endif</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>
<a name="l00113"></a>00113 <span class="preprocessor">#endif </span><span class="comment">/* openssl.h */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun Mar 16 15:31:51 2008 for XySSL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1 </small></address>
</body>
</html>
